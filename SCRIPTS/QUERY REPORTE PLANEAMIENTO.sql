SET DATEFORMAT DMY; 
SELECT CLI,NOM,TEMPO, FABRIC,PO,ESTCLI,OFI,PROTO,COLOR, LLEGAPO, 
[XS], [S], [M] , [L], [XL], [XXL], [3XL],[4XL],[5XL], [6XL],[7XL],[8XL], TOTAL, 
[_XS], [_S],[_M], [_L], [_XL], [_XXL], [_3XL],[_4XL], [_5XL], [_6XL], [_7XL], [_8XL],
([_XS]+ [_S]+[_M]+[_L]+[_XL]+ [_XXL]+[_3XL]+[_4XL]+[_5XL]+[_6XL]+ [_7XL]+ [_8XL]) AS _TOTAL, 
[ID], CONSUMO, CANPZA, [CODIGO],
SPACE(10) AS ACOD, 0 AS A0, 0 AS A1, 0 AS A2, 0 AS A3, 0 AS A4, 0 AS A5, 0 AS A6, 0 AS A7, 0 AS A8, 0 AS A9, 0 AS A10, 0 AS A11, 0 AS A_TOT_12,  
SPACE(10) AS BCOD, 0 AS B0, 0 AS B1, 0 AS B2, 0 AS B3, 0 AS B4, 0 AS B5, 0 AS B6, 0 AS B7, 0 AS B8, 0 AS B9, 0 AS B10, 0 AS B11, 0 AS B_TOT_12,
SPACE(10) AS CCOD, 0 AS C0, 0 AS C1, 0 AS C2, 0 AS C3, 0 AS C4, 0 AS C5, 0 AS C6, 0 AS C7, 0 AS C8, 0 AS C9, 0 AS C10, 0 AS C11, 0 AS C_TOT_12,
SPACE(10) AS DCOD, 0 AS D0, 0 AS D1, 0 AS D2, 0 AS D3, 0 AS D4, 0 AS D5, 0 AS D6, 0 AS D7, 0 AS D8, 0 AS D9, 0 AS D10, 0 AS D11, 0 AS D_TOT_12,
SPACE(10) AS ECOD, 0 AS E0, 0 AS E1, 0 AS E2, 0 AS E3, 0 AS E4, 0 AS E5, 0 AS E6, 0 AS E7, 0 AS E8, 0 AS E9, 0 AS E10, 0 AS E11, 0 AS E_TOT_12,
SPACE(10) AS FCOD, 0 AS F0, 0 AS F1, 0 AS F2, 0 AS F3, 0 AS F4, 0 AS F5, 0 AS F6, 0 AS F7, 0 AS F8, 0 AS F9, 0 AS F10, 0 AS F11, 0 AS F_TOT_12,
SPACE(10) AS GCOD, 0 AS G0, 0 AS G1, 0 AS G2, 0 AS G3, 0 AS G4, 0 AS G5, 0 AS G6, 0 AS G7, 0 AS G8, 0 AS G9, 0 AS G10, 0 AS G11, 0 AS G_TOT_12,
SPACE(10) AS HCOD, 0 AS H0, 0 AS H1, 0 AS H2, 0 AS H3, 0 AS H4, 0 AS H5, 0 AS H6, 0 AS H7, 0 AS H8, 0 AS H9, 0 AS H10, 0 AS H11, 0 AS H_TOT_12,
SPACE(10) AS ICOD, 0 AS I0, 0 AS I1, 0 AS I2, 0 AS I3, 0 AS I4, 0 AS I5, 0 AS I6, 0 AS I7, 0 AS I8, 0 AS I9, 0 AS I10, 0 AS I11, 0 AS I_TOT_12,
SPACE(10) AS JCOD, 0 AS J0, 0 AS J1, 0 AS J2, 0 AS J3, 0 AS J4, 0 AS J5, 0 AS J6, 0 AS J7, 0 AS J8, 0 AS J9, 0 AS J10, 0 AS J11, 0 AS J_TOT_12,
SPACE(10) AS KCOD, 0 AS K0, 0 AS K1, 0 AS K2, 0 AS K3, 0 AS K4, 0 AS K5, 0 AS K6, 0 AS K7, 0 AS K8, 0 AS K9, 0 AS K10, 0 AS K11, 0 AS K_TOT_12,
SPACE(10) AS LCOD, 0 AS L0, 0 AS L1, 0 AS L2, 0 AS L3, 0 AS L4, 0 AS L5, 0 AS L6, 0 AS L7, 0 AS L8, 0 AS L9, 0 AS L10, 0 AS L11, 0 AS L_TOT_12,
SPACE(10) AS MCOD, 0 AS M0, 0 AS M1, 0 AS M2, 0 AS M3, 0 AS M4, 0 AS M5, 0 AS M6, 0 AS M7, 0 AS M8, 0 AS M9, 0 AS M10, 0 AS M11, 0 AS M_TOT_12,
SPACE(10) AS NCOD, 0 AS N0, 0 AS N1, 0 AS N2, 0 AS N3, 0 AS N4, 0 AS N5, 0 AS N6, 0 AS N7, 0 AS N8, 0 AS N9, 0 AS N10, 0 AS N11, 0 AS N_TOT_12,
SPACE(10) AS OCOD, 0 AS O0, 0 AS O1, 0 AS O2, 0 AS O3, 0 AS O4, 0 AS O5, 0 AS O6, 0 AS O7, 0 AS O8, 0 AS O9, 0 AS O10, 0 AS O11, 0 AS O_TOT_12,
SPACE(10) AS PCOD, 0 AS P0, 0 AS P1, 0 AS P2, 0 AS P3, 0 AS P4, 0 AS P5, 0 AS P6, 0 AS P7, 0 AS P8, 0 AS P9, 0 AS P10, 0 AS P11, 0 AS P_TOT_12,
SPACE(10) AS QCOD, 0 AS Q0, 0 AS Q1, 0 AS Q2, 0 AS Q3, 0 AS Q4, 0 AS Q5, 0 AS Q6, 0 AS Q7, 0 AS Q8, 0 AS Q9, 0 AS Q10, 0 AS Q11, 0 AS Q_TOT_12,
SPACE(10) AS RCOD, 0 AS R0, 0 AS R1, 0 AS R2, 0 AS R3, 0 AS R4, 0 AS R5, 0 AS R6, 0 AS R7, 0 AS R8, 0 AS R9, 0 AS R10, 0 AS R11, 0 AS R_TOT_12,
SPACE(10) AS SCOD, 0 AS S0, 0 AS S1, 0 AS S2, 0 AS S3, 0 AS S4, 0 AS S5, 0 AS S6, 0 AS S7, 0 AS S8, 0 AS S9, 0 AS S10, 0 AS S11, 0 AS S_TOT_12,
SPACE(10) AS TCOD, 0 AS T0, 0 AS T1, 0 AS T2, 0 AS T3, 0 AS T4, 0 AS T5, 0 AS T6, 0 AS T7, 0 AS T8, 0 AS T9, 0 AS T10, 0 AS T11, 0 AS T_TOT_12,
SPACE(10) AS UCOD, 0 AS U0, 0 AS U1, 0 AS U2, 0 AS U3, 0 AS U4, 0 AS U5, 0 AS U6, 0 AS U7, 0 AS U8, 0 AS U9, 0 AS U10, 0 AS U11, 0 AS U_TOT_12,
SPACE(10) AS VCOD, 0 AS V0, 0 AS V1, 0 AS V2, 0 AS V3, 0 AS V4, 0 AS V5, 0 AS V6, 0 AS V7, 0 AS V8, 0 AS V9, 0 AS V10, 0 AS V11, 0 AS V_TOT_12,
SPACE(10) AS WCOD, 0 AS W0, 0 AS W1, 0 AS W2, 0 AS W3, 0 AS W4, 0 AS W5, 0 AS W6, 0 AS W7, 0 AS W8, 0 AS W9, 0 AS W10, 0 AS W11, 0 AS W_TOT_12,
SPACE(10) AS XCOD, 0 AS X0, 0 AS X1, 0 AS X2, 0 AS X3, 0 AS X4, 0 AS X5, 0 AS X6, 0 AS X7, 0 AS X8, 0 AS X9, 0 AS X10, 0 AS X11, 0 AS X_TOT_12,
SPACE(10) AS YCOD, 0 AS Y0, 0 AS Y1, 0 AS Y2, 0 AS Y3, 0 AS Y4, 0 AS Y5, 0 AS Y6, 0 AS Y7, 0 AS Y8, 0 AS Y9, 0 AS Y10, 0 AS Y11, 0 AS Y_TOT_12,
SPACE(10) AS ZCOD, 0 AS Z0, 0 AS Z1, 0 AS Z2, 0 AS Z3, 0 AS Z4, 0 AS Z5, 0 AS Z6, 0 AS Z7, 0 AS Z8, 0 AS Z9, 0 AS Z10, 0 AS Z11, 0 AS Z_TOT_12
INTO #TMP1
FROM VIEW_PEDIDO_TELA_DETA 
where  estado = 'a' and cli = '00001' and estcli = '540391' and codtem = '026' 
ORDER BY REPLACE(PO, ' ' , ''), REPLACE(COLOR, ' ', ''), ID
SELECT * FROM #TMP1
--DROP TABLE  #TMP1
-- PASO DE TMP1 A TMP2 EN BLANCO PORQUE TMP1 TIENE TODAS LAS LINEAS DE LOS CODIGOS DE LAS TELAS EN VERTICAL Y NECESITO HACER
-- UN PIVOT POR CODIGO DE TELA A COLUMNAS....
SELECT * INTO #TMP2 FROM #TMP1 WHERE 2=1

DECLARE @PO CHAR(20), @color VARCHAR(30), @TELA CHAR(10), @ID INT, @maxi int, @CNT INT, @CONS NUMERIC(18,0), @CANTI NUMERIC(10)
SET @CNT = 0
-- bARRE EL PRIMER TEMPORAL 
WHILE (EXISTS(SELECT PO, REPLACE(COLOR, ' ' ,'') FROM #TMP1))
	BEGIN
		SET @PO    = (SELECT TOP 1 REPLACE(PO, ' ','') FROM  #TMP1  ORDER BY PO, COLOR, ID)
		SET @COLOR = (SELECT TOP 1 REPLACE(COLOR, ' ' ,'')  FROM  #TMP1  
					 WHERE REPLACE(PO, ' ','') =  @PO)
		SET @MAXI  = (SELECT MAX(ID) FROM #TMP1  WHERE REPLACE(COLOR, ' ' ,'') = @COLOR AND REPLACE(PO, ' ','') =  @PO)
		SET @TELA  = (SELECT TOP 1 CODIGO  FROM #TMP1 WHERE REPLACE(PO, ' ','') = @PO)
		SET @CONS  = (SELECT TOP 1 CONSUMO FROM #TMP1 WHERE REPLACE(COLOR, ' ' ,'') = @COLOR AND REPLACE(PO, ' ','') = @PO AND [ID]=@ID)
		SET @CANTI = (SELECT TOP 1 CONSUMO FROM #TMP1 WHERE REPLACE(COLOR, ' ' ,'') = @COLOR AND REPLACE(PO, ' ','') = @PO AND [ID]=@ID)
		-- MAXI TIENE ELO NUMERO DE LINEAS CON CODIGO DE TELA
		-- HAY QUE INGRESAR UN BLOQUE POR CADA linea PARA TODOS LOS COLORES
		WHILE (EXISTS(SELECT PO FROM #TMP1))
			BEGIN
				-- INSERTA todos LOS COLORES CON EL PRIMER BLOQUE DE LA TELA PRINCIPAL (ID=0)
				WHILE (EXISTS(SELECT PO FROM #TMP1 WHERE  REPLACE(COLOR, ' ', '')= @COLOR ))
					BEGIN
						INSERT INTO #TMP2 
							SELECT  CLI, NOM,TEMPO, FABRIC, PO, ESTCLI, OFI, PROTO, COLOR, LLEGAPO,
							[XS],  [S],   [M] ,  [L],  [XL] , [XXL], [3XL],  [4XL],  [5XL],  [6XL],  [7XL],  [8XL], TOTAL,  
							[_XS], [_S], [_M] , [_L], [_XL], [_XXL], [_3XL], [_4XL], [_5XL], [_6XL], [_7XL], [_8XL], _TOTAL, 
							[ID], @CONS, @CANTI, 'A',
							@TELA,  ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN [_XS] * @CANTI ELSE [_XS] * @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_S]   * @CANTI ELSE [_S]  * @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_M]   * @CANTI ELSE [_M]  * @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_L]   * @CANTI ELSE [_L]  * @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_XL]  * @CANTI ELSE [_XL] * @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_XXL] * @CANTI ELSE [_XXL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_3XL] * @CANTI ELSE [_3XL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_4XL] * @CANTI ELSE [_4XL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_5XL] * @CANTI ELSE [_5XL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_6XL] * @CANTI ELSE [_6XL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_7XL] * @CANTI ELSE [_7XL]* @CONS END , 0),
									ISNULL(CASE WHEN LEFT(@TELA,1) = '9' THEN[_8XL] * @CANTI ELSE [_8XL]* @CONS END , 0), _TOTAL, 
									'B', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'C', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'D', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'E', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'F', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'G', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'H', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'U', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'J', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'K', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'L', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'M', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'N', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'O', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'P', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'Q', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'R', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'S', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'T', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'U', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'V', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'w', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'X', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'Y', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,
									'Z', 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0
							
							FROM #TMP1 WHERE REPLACE(PO, ' ','') = @PO AND ID=0 AND REPLACE(COLOR, ' ' ,'')= @COLOR


						DELETE #TMP1  WHERE REPLACE(PO, ' ','') =  @PO  AND REPLACE(COLOR, ' ' ,'') = @COLOR AND ID= 0 AND @TELA= CODIGO
					END
			END
		WHILE @CNT < @MAXI
			BEGIN
				-- EL CONTADOR VA A 1 PORQUE YA SE INGRESO LA TELA PRINCIPAL
				SET @CNT= @CNT +1
				-- aca hay que hacer los 28 bloques para cada posible tela..... lo mismo corriendo una letra
				-- LOS SIGUIENTES SON un update a #TMP2 !!! iojo
					BEGIN
						
						DELETE #TMP1   WHERE REPLACE(PO, ' ','') =  @PO  AND REPLACE(COLOR, ' ' ,'') = @COLOR AND ID= @ID
					END
				

			END
		DELETE #TMP1 WHERE REPLACE(PO, ' ','') = @PO

	END


	

select * from #tmp2

--
--DROP TABLE #TMP2
